// ========================================
// MIGRA√á√ÉO DE IMAGENS EXISTENTES
// Organiza imagens atuais por se√ß√µes no Firebase
// ========================================

class ImageMigration {
    constructor() {
        this.imageMapping = {
            // SE√á√ÉO SERVI√áOS
            services: [
                {
                    filename: 'img/cabelo e barba.jpeg',
                    title: 'CABELO E BARBA',
                    description: 'Corte completo com acabamento perfeito da barba, deixando voc√™ com visual impec√°vel'
                },
                {
                    filename: 'img/Corte infantil.jpeg',
                    title: 'CORTE INFANTIL',
                    description: 'Atendimento especializado para crian√ßas com ambiente acolhedor e profissionais experientes'
                },
                {
                    filename: 'img/pigmentacao.jpeg',
                    title: 'PIGMENTA√á√ÉO',
                    description: 'T√©cnica avan√ßada para cobertura de fios brancos e realce da cor natural'
                },
                {
                    filename: 'img/sombracelha.jpeg',
                    title: 'SOBRANCELHA',
                    description: 'Design e modelagem de sobrancelhas para valorizar o olhar masculino'
                },
                {
                    filename: 'img/classico na tesoura.jpeg',
                    title: 'CORTE NA TESOURA',
                    description: 'T√©cnica cl√°ssica com acabamento refinado para um visual sofisticado'
                },
                {
                    filename: 'img/luzes.jpeg',
                    title: 'LUZES',
                    description: 'Mechas e luzes para criar um visual moderno e diferenciado'
                },
                {
                    filename: 'img/platinado.jpeg',
                    title: 'PLATINADO',
                    description: 'Colora√ß√£o platinada para um visual arrojado e contempor√¢neo'
                }
            ],

            // SE√á√ÉO GALERIA
            gallery: [
                {
                    filename: 'img/Corte taper fade Americano.jpeg',
                    title: 'Taper Fade Americano',
                    description: 'Estilo americano moderno com degrad√™ apenas no in√≠cio da parte de tr√°s'
                },
                {
                    filename: 'img/Mid fade.jpeg',
                    title: 'Mid Fade',
                    description: 'Sombreado gradual vis√≠vel e marcado a partir da metade da cabe√ßa'
                },
                {
                    filename: 'img/High fadeDegrad√™ alto.jpeg',
                    title: 'High Fade',
                    description: 'Degrad√™ alto com transi√ß√£o suave e acabamento moderno'
                },
                {
                    filename: 'img/Social Cl√°ssico..jpeg',
                    title: 'Social Cl√°ssico',
                    description: 'Corte social tradicional com toque contempor√¢neo'
                },
                {
                    filename: 'img/corte_social.jpeg',
                    title: 'Corte Social',
                    description: 'Estilo social refinado para o dia a dia profissional'
                },
                {
                    filename: 'img/Low fadeDegrad√™ baixo.jpeg',
                    title: 'Low Fade',
                    description: 'Degrad√™ baixo discreto e elegante'
                },
                {
                    filename: 'img/freestyle.jpeg',
                    title: 'Freestyle',
                    description: 'Corte personalizado e criativo'
                },
                {
                    filename: 'img/Curly hair..jpeg',
                    title: 'Cabelo Cacheado',
                    description: 'Especializa√ß√£o em cabelos cacheados e crespos'
                }
            ],

            // SE√á√ÉO EQUIPE/AMBIENTE
            team: [
                {
                    filename: 'img/proprietario.jpeg',
                    title: 'Samuel Abreu',
                    description: 'Propriet√°rio e Barbeiro Master com 11 anos de experi√™ncia'
                },
                {
                    filename: 'img/proprietario 2.jpeg',
                    title: 'Profissionalismo',
                    description: 'Dedica√ß√£o e aten√ß√£o aos detalhes em cada atendimento'
                },
                {
                    filename: 'img/barbearia.jpeg',
                    title: 'Nossa Barbearia',
                    description: 'Ambiente acolhedor e moderno para seu conforto'
                },
                {
                    filename: 'img/pro1.jpeg',
                    title: 'Estrutura Moderna',
                    description: 'Equipamentos de √∫ltima gera√ß√£o para melhor resultado'
                },
                {
                    filename: 'img/pro2.jpeg',
                    title: 'Trabalho Especializado',
                    description: 'T√©cnicas avan√ßadas e produtos de qualidade'
                },
                {
                    filename: 'img/pro3.jpeg',
                    title: 'Resultados Excepcionais',
                    description: 'Clientes satisfeitos e transforma√ß√µes incr√≠veis'
                },
                {
                    filename: 'img/kaioUm.jpeg',
                    title: 'Kaio - Barbeiro',
                    description: 'Barbeiro profissional especializado em cortes modernos'
                },
                {
                    filename: 'img/kaioDois.jpeg',
                    title: 'Equipe Qualificada',
                    description: 'Profissionais treinados e experientes'
                },
                {
                    filename: 'img/samu.jpeg',
                    title: 'Samuel em A√ß√£o',
                    description: 'Barbeiro master demonstrando sua t√©cnica'
                },
                {
                    filename: 'img/forcemen.jpeg',
                    title: 'For√ßa e Estilo',
                    description: 'Combina√ß√£o perfeita de masculinidade e eleg√¢ncia'
                }
            ],

            // SE√á√ÉO HERO/LOGO
            hero: [
                {
                    filename: 'img/logo_barber.png',
                    title: 'Logo Barbearia Samuel Abreu',
                    description: 'Logotipo oficial da barbearia'
                },
                {
                    filename: 'img/logo_baber_branco.png',
                    title: 'Logo Branco',
                    description: 'Vers√£o branca do logotipo para fundos escuros'
                }
            ]
        };
    }

    // Migrar todas as imagens existentes
    async migrateAllImages() {
        if (!window.db) {
            console.error('Firebase n√£o inicializado');
            return;
        }

        const results = {
            success: 0,
            errors: 0,
            skipped: 0
        };

        for (const [section, images] of Object.entries(this.imageMapping)) {
            console.log(`üìÇ Migrando se√ß√£o: ${section}`);
            
            for (const imageData of images) {
                try {
                    // Verificar se a imagem j√° existe no Firebase
                    const exists = await this.checkImageExists(imageData.filename, section);
                    
                    if (exists) {
                        console.log(`‚è≠Ô∏è Imagem j√° existe: ${imageData.filename}`);
                        results.skipped++;
                        continue;
                    }

                    // Criar registro no Firebase (sem upload, usando URL local)
                    await this.createImageRecord(imageData, section);
                    
                    console.log(`‚úÖ Migrada: ${imageData.title}`);
                    results.success++;
                    
                } catch (error) {
                    console.error(`‚ùå Erro ao migrar ${imageData.filename}:`, error);
                    results.errors++;
                }
            }
        }

        console.log('üìä Resultados da migra√ß√£o:', results);
        return results;
    }

    // Verificar se imagem j√° existe no Firebase
    async checkImageExists(filename, section) {
        const snapshot = await db.collection('images')
            .where('section', '==', section)
            .where('filename', '==', filename)
            .get();
        
        return !snapshot.empty;
    }

    // Criar registro da imagem no Firebase
    async createImageRecord(imageData, section) {
        const record = {
            title: imageData.title,
            description: imageData.description,
            section: section,
            url: imageData.filename, // URL local por enquanto
            filename: imageData.filename,
            isMigrated: true,
            needsUpload: true, // Flag para indicar que precisa fazer upload
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: 'migration_script'
        };

        await db.collection('images').add(record);
    }

    // Converter imagem local para Cloudinary
    async uploadLocalImageToCloudinary(filename) {
        try {
            // Buscar a imagem no diret√≥rio local
            const response = await fetch(filename);
            const blob = await response.blob();
            
            // Criar File object
            const file = new File([blob], filename.split('/').pop(), { type: blob.type });
            
            // Usar o ImageManager para fazer upload
            if (window.ImageManager) {
                const manager = new ImageManager();
                return await manager.uploadImageToCloudinary(file);
            }
            
            throw new Error('ImageManager n√£o dispon√≠vel');
            
        } catch (error) {
            console.error('Erro ao fazer upload:', error);
            throw error;
        }
    }

    // Atualizar URLs locais para URLs do Cloudinary
    async upgradeLocalImages() {
        const snapshot = await db.collection('images')
            .where('needsUpload', '==', true)
            .get();

        const results = {
            upgraded: 0,
            errors: 0
        };

        for (const doc of snapshot.docs) {
            try {
                const data = doc.data();
                
                // Upload para Cloudinary
                const cloudinaryResult = await this.uploadLocalImageToCloudinary(data.filename);
                
                // Atualizar registro no Firebase
                await doc.ref.update({
                    url: cloudinaryResult.url,
                    publicId: cloudinaryResult.publicId,
                    width: cloudinaryResult.width,
                    height: cloudinaryResult.height,
                    needsUpload: false,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log(`üîÑ URL atualizada: ${data.title}`);
                results.upgraded++;

            } catch (error) {
                console.error(`‚ùå Erro ao atualizar ${doc.data().title}:`, error);
                results.errors++;
            }
        }

        return results;
    }

    // Executar migra√ß√£o completa
    async runFullMigration() {
        console.log('üöÄ Iniciando migra√ß√£o completa...');
        
        // Passo 1: Migrar estrutura
        const migrationResults = await this.migrateAllImages();
        console.log('‚úÖ Migra√ß√£o de estrutura conclu√≠da:', migrationResults);
        
        // Aguardar um pouco antes do pr√≥ximo passo
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Passo 2: Fazer upload das imagens (opcional)
        // const uploadResults = await this.upgradeLocalImages();
        // console.log('‚úÖ Upload para Cloudinary conclu√≠do:', uploadResults);
        
        console.log('üéâ Migra√ß√£o completa finalizada!');
        
        return {
            migration: migrationResults
            // upload: uploadResults
        };
    }
}

// Fun√ß√£o global para executar migra√ß√£o
window.runImageMigration = async function() {
    if (!window.db) {
        alert('‚ùå Firebase n√£o inicializado. Aguarde ou recarregue a p√°gina.');
        return;
    }

    if (confirm('üîÑ Deseja migrar as imagens existentes para o Firebase?\n\nIsso organizar√° todas as imagens por se√ß√µes.')) {
        const migration = new ImageMigration();
        
        try {
            const results = await migration.runFullMigration();
            
            alert(`‚úÖ Migra√ß√£o conclu√≠da!\n\nüìä Resultados:\n- Sucesso: ${results.migration.success}\n- Erros: ${results.migration.errors}\n- Ignoradas: ${results.migration.skipped}`);
            
            // Recarregar imagens no dashboard se dispon√≠vel
            if (window.dashboard && window.dashboard.imageManager) {
                await window.dashboard.imageManager.loadImages();
            }
            
        } catch (error) {
            console.error('Erro na migra√ß√£o:', error);
            alert(`‚ùå Erro na migra√ß√£o: ${error.message}`);
        }
    }
};

// Adicionar bot√£o de migra√ß√£o ao dashboard se n√£o existir
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (window.location.pathname.includes('admin-dashboard')) {
            const migrationBtn = document.createElement('button');
            migrationBtn.textContent = 'üîÑ Migrar Imagens Existentes';
            migrationBtn.className = 'action-btn';
            migrationBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; background: linear-gradient(45deg, #ff9800, #f57c00);';
            migrationBtn.onclick = window.runImageMigration;
            
            document.body.appendChild(migrationBtn);
        }
    }, 3000);
});

// Exportar para uso global
if (typeof window !== 'undefined') {
    window.ImageMigration = ImageMigration;
}
