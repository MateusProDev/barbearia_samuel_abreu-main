<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Dashboard - Barbearia Samuel Abreu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-item {
            background: #2a2a2a;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }
        .status {
            font-weight: bold;
        }
        .status.ok { color: #4CAF50; }
        .status.error { color: #ff4444; }
        .status.loading { color: #ff9800; }
        button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #f4d03f;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Teste do Sistema de Dashboard</h1>
        
        <div class="test-item">
            <h3>🔥 Firebase</h3>
            <p>Status: <span id="firebase-status" class="status loading">Carregando...</span></p>
            <button onclick="testFirebase()">Testar Firebase</button>
        </div>
        
        <div class="test-item">
            <h3>🖼️ Image Manager</h3>
            <p>Status: <span id="imagemanager-status" class="status loading">Carregando...</span></p>
            <button onclick="testImageManager()">Testar Image Manager</button>
        </div>
        
        <div class="test-item">
            <h3>📊 Coleção de Imagens</h3>
            <p>Total de imagens: <span id="total-images">-</span></p>
            <p>Imagens ativas: <span id="active-images">-</span></p>
            <button onclick="loadImages()">Carregar Imagens</button>
        </div>
        
        <div class="test-item">
            <h3>🔄 Sincronização</h3>
            <p>Status: <span id="sync-status" class="status loading">Aguardando...</span></p>
            <button onclick="testSync()">Testar Sincronização</button>
        </div>

        <div class="test-item">
            <h3>📤 Upload de Teste</h3>
            <p>Status: <span id="upload-status" class="status">Pronto</span></p>
            <input type="file" id="test-file" accept="image/*">
            <button onclick="testUpload()">Testar Upload</button>
        </div>

        <div class="test-item">
            <h3>📋 Log de Atividades</h3>
            <div id="log" style="background: #000; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                Aguardando atividades...
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="image-manager.js"></script>
    
    <script>
        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCTcvqfii2TE08vqolCgqv0jI9VWTfarOA",
            authDomain: "barbeariasamuelabreu.firebaseapp.com",
            projectId: "barbeariasamuelabreu",
            storageBucket: "barbeariasamuelabreu.firebasestorage.app",
            messagingSenderId: "690733163957",
            appId: "1:690733163957:web:c3f77d1219a81eeeb6e5fc"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.db = db;

        let testLog = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${message}`);
            document.getElementById('log').innerHTML = testLog.slice(-10).join('<br>');
            console.log(message);
        }

        async function testFirebase() {
            try {
                log('🔄 Testando conexão Firebase...');
                await db.collection('test').doc('connection').set({ 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true 
                });
                document.getElementById('firebase-status').textContent = 'Conectado';
                document.getElementById('firebase-status').className = 'status ok';
                log('✅ Firebase conectado com sucesso');
            } catch (error) {
                document.getElementById('firebase-status').textContent = 'Erro';
                document.getElementById('firebase-status').className = 'status error';
                log('❌ Erro no Firebase: ' + error.message);
            }
        }

        function testImageManager() {
            if (window.imageManager) {
                document.getElementById('imagemanager-status').textContent = 'Carregado';
                document.getElementById('imagemanager-status').className = 'status ok';
                log('✅ ImageManager carregado');
            } else {
                document.getElementById('imagemanager-status').textContent = 'Não carregado';
                document.getElementById('imagemanager-status').className = 'status error';
                log('❌ ImageManager não encontrado');
            }
        }

        async function loadImages() {
            try {
                log('📥 Carregando imagens do Firebase...');
                const snapshot = await db.collection('images').get();
                const activeImages = snapshot.docs.filter(doc => doc.data().active !== false);
                
                document.getElementById('total-images').textContent = snapshot.size;
                document.getElementById('active-images').textContent = activeImages.length;
                
                log(`📊 Total: ${snapshot.size} imagens, ${activeImages.length} ativas`);
            } catch (error) {
                log('❌ Erro ao carregar imagens: ' + error.message);
            }
        }

        function testSync() {
            // Testar se o evento de sincronização funciona
            const syncEvent = new CustomEvent('imagesUpdated', {
                detail: { timestamp: Date.now(), source: 'test' }
            });
            
            window.dispatchEvent(syncEvent);
            document.getElementById('sync-status').textContent = 'Evento disparado';
            document.getElementById('sync-status').className = 'status ok';
            log('🔄 Evento de sincronização disparado');
        }

        async function testUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('upload-status').textContent = 'Selecione um arquivo';
                document.getElementById('upload-status').className = 'status error';
                return;
            }

            try {
                log('📤 Testando upload para Cloudinary...');
                document.getElementById('upload-status').textContent = 'Enviando...';
                document.getElementById('upload-status').className = 'status loading';

                // Simular upload com ImageManager
                if (window.imageManager) {
                    const formData = new FormData();
                    formData.append("file", file);
                    formData.append("upload_preset", "qc7tkpck");
                    formData.append("cloud_name", "doeiv6m4h");

                    const response = await fetch(
                        "https://api.cloudinary.com/v1_1/doeiv6m4h/image/upload",
                        { method: "POST", body: formData }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Salvar no Firebase
                        await db.collection('images').add({
                            title: 'Teste Upload',
                            description: 'Imagem de teste do sistema',
                            section: 'test',
                            url: data.secure_url,
                            cloudinaryUrl: data.secure_url,
                            filename: file.name,
                            active: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: 'test-system'
                        });

                        document.getElementById('upload-status').textContent = 'Sucesso!';
                        document.getElementById('upload-status').className = 'status ok';
                        log('✅ Upload realizado com sucesso: ' + file.name);
                        
                        // Recarregar estatísticas
                        setTimeout(loadImages, 1000);
                    } else {
                        throw new Error('Erro na resposta do servidor');
                    }
                } else {
                    throw new Error('ImageManager não disponível');
                }
            } catch (error) {
                document.getElementById('upload-status').textContent = 'Erro';
                document.getElementById('upload-status').className = 'status error';
                log('❌ Erro no upload: ' + error.message);
            }
        }

        // Inicializar testes quando carregar
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 Sistema de teste iniciado');
            
            setTimeout(() => {
                testFirebase();
                testImageManager();
                loadImages();
            }, 1000);
        });

        // Escutar eventos de sincronização
        window.addEventListener('imagesUpdated', (event) => {
            log('📡 Evento de sincronização recebido: ' + JSON.stringify(event.detail));
        });
    </script>
</body>
</html>