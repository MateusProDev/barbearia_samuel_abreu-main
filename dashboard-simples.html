<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Simples - Barbearia Samuel Abreu</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }
        .upload-section {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #D4AF37;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            background: #333;
            color: white;
            border-radius: 5px;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #D4AF37;
        }
        .btn {
            background: #D4AF37;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
        }
        .btn:hover {
            background: #B8941F;
        }
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .images-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .image-card {
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .image-info {
            padding: 10px;
        }
        .image-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .image-category {
            color: #D4AF37;
            font-size: 14px;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #4CAF50; color: white; }
        .error { background: #f44336; color: white; }
        .info { background: #2196F3; color: white; }
        .warning { background: #FF9800; color: white; }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        .category-section {
            margin-bottom: 30px;
        }
        .category-title {
            background: #D4AF37;
            color: #000;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Dashboard - Barbearia Samuel Abreu</h1>
            <p>Sistema Simples de Upload de Imagens</p>
            <div id="status">Carregando...</div>
            <button class="btn" onclick="testarConexao()" style="font-size: 14px; padding: 8px 15px; margin-top: 10px;">
                üîß Testar Conex√£o
            </button>
        </div>

        <!-- Upload Section -->
        <div class="upload-section">
            <h2>üì§ Adicionar Nova Imagem</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="imageFile">Imagem:</label>
                    <input type="file" id="imageFile" accept="image/*" required>
                </div>
                
                <div class="form-group">
                    <label for="imageTitle">T√≠tulo:</label>
                    <input type="text" id="imageTitle" placeholder="Ex: Corte Moderno" required>
                </div>
                
                <div class="form-group">
                    <label for="imageCategory">Categoria:</label>
                    <select id="imageCategory" required>
                        <option value="">Selecione uma categoria</option>
                        <option value="hero">üéØ Hero/Banner Principal</option>
                        <option value="services">‚úÇÔ∏è Servi√ßos</option>
                        <option value="gallery">üñºÔ∏è Galeria de Trabalhos</option>
                        <option value="team">üë• Equipe</option>
                    </select>
                </div>
                
                <button type="submit" class="btn" id="uploadBtn">
                    üì§ Adicionar Imagem
                </button>
            </form>
        </div>

        <!-- Messages -->
        <div id="messages"></div>

        <!-- Images Display -->
        <div id="imagesContainer">
            <div class="loading">Carregando imagens...</div>
        </div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCTcvqfii2TE08vqolCgqv0jI9VWTfarOA",
            authDomain: "barbeariasamuelabreu.firebaseapp.com",
            projectId: "barbeariasamuelabreu",
            storageBucket: "barbeariasamuelabreu.firebasestorage.app",
            messagingSenderId: "690733163957",
            appId: "1:690733163957:web:c3f77d1219a81eeeb6e5fc"
        };

        let db, storage;
        let images = {};

        // Inicializar Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                storage = firebase.storage();
                
                showStatus('‚úÖ Firebase conectado!', 'success');
                loadImages();
            } catch (error) {
                console.error('Erro Firebase:', error);
                showStatus('‚ùå Erro ao conectar Firebase: ' + error.message, 'error');
            }
        }

        // Mostrar mensagem
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const messagesDiv = document.getElementById('messages');
            
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `status ${type}`;
            msgDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messagesDiv.appendChild(msgDiv);
            
            // Auto-remover ap√≥s 5 segundos
            setTimeout(() => {
                if (msgDiv.parentNode) {
                    msgDiv.parentNode.removeChild(msgDiv);
                }
            }, 5000);
        }

        // Carregar imagens
        async function loadImages() {
            try {
                showStatus('üîç Carregando imagens...', 'info');
                
                const snapshot = await db.collection('images').get();
                images = { hero: [], services: [], gallery: [], team: [] };
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    // Mapear se√ß√µes existentes para categorias do dashboard
                    let category = data.section || data.category || 'gallery';
                    
                    // Converter nomes das se√ß√µes para match com estrutura existente
                    if (category === 'services') category = 'services';
                    else if (category === 'team') category = 'team';
                    else if (category === 'hero' || category === 'banner') category = 'hero';
                    else category = 'gallery'; // Default para gallery
                    
                    if (!images[category]) {
                        images[category] = [];
                    }
                    
                    images[category].push(data);
                });
                
                const total = Object.values(images).reduce((sum, arr) => sum + arr.length, 0);
                showStatus(`‚úÖ ${total} imagens carregadas`, 'success');
                
                displayImages();
            } catch (error) {
                console.error('Erro ao carregar:', error);
                showStatus('‚ùå Erro ao carregar imagens: ' + error.message, 'error');
            }
        }

        // Exibir imagens
        function displayImages() {
            const container = document.getElementById('imagesContainer');
            container.innerHTML = '';

            const categories = {
                hero: 'üéØ Hero/Banner Principal',
                services: '‚úÇÔ∏è Servi√ßos', 
                gallery: 'üñºÔ∏è Galeria de Trabalhos',
                team: 'üë• Equipe'
            };

            Object.entries(categories).forEach(([key, title]) => {
                const categoryImages = images[key] || [];
                
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = `${title} (${categoryImages.length})`;
                section.appendChild(categoryTitle);

                const imagesSection = document.createElement('div');
                imagesSection.className = 'images-section';
                
                if (categoryImages.length === 0) {
                    imagesSection.innerHTML = '<p style="text-align: center; color: #888;">Nenhuma imagem nesta categoria</p>';
                } else {
                    const grid = document.createElement('div');
                    grid.className = 'images-grid';
                    
                    categoryImages.forEach(img => {
                        const card = createImageCard(img);
                        grid.appendChild(card);
                    });
                    
                    imagesSection.appendChild(grid);
                }
                
                section.appendChild(imagesSection);
                container.appendChild(section);
            });
        }

        // Criar card de imagem
        function createImageCard(img) {
            const card = document.createElement('div');
            card.className = 'image-card';
            
            card.innerHTML = `
                <img src="${img.url}" alt="${img.alt || img.title}" 
                     onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"200\\" height=\\"200\\"><rect width=\\"200\\" height=\\"200\\" fill=\\"%23333\\"/><text x=\\"100\\" y=\\"100\\" text-anchor=\\"middle\\" dy=\\".3em\\" fill=\\"white\\">Erro</text></svg>'">
                <div class="image-info">
                    <div class="image-title">${img.title}</div>
                    <div class="image-category">${img.section || img.category}</div>
                    ${img.description ? `<div style="font-size: 12px; color: #aaa; margin-top: 5px;">${img.description}</div>` : ''}
                </div>
                <button class="delete-btn" onclick="deleteImage('${img.id}', '${img.section || img.category}')" title="Deletar">√ó</button>
            `;
            
            return card;
        }

        // Upload de imagem
        async function uploadImage(file, title, category) {
            try {
                const fileName = `${category}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                console.log(`üì§ Tentando upload: ${fileName}`);
                
                // Verificar se Firebase est√° inicializado
                if (!storage) {
                    throw new Error('Firebase Storage n√£o inicializado');
                }
                
                // M√©todo 1: Tentar upload normal no Firebase Storage
                try {
                    showStatus('üì§ Fazendo upload no Firebase Storage...', 'info');
                    
                    const storageRef = storage.ref(fileName);
                    console.log('üìÅ Refer√™ncia criada:', storageRef.fullPath);
                    
                    const snapshot = await storageRef.put(file);
                    console.log('‚úÖ Upload completo no Storage');
                    
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    console.log('üîó URL obtida:', downloadURL);
                    
                    showStatus('‚úÖ Upload no Storage realizado!', 'success');
                    return downloadURL;
                    
                } catch (uploadError) {
                    console.warn('‚ö†Ô∏è Upload normal falhou:', uploadError);
                    
                    // M√©todo 2: Base64 como fallback SEMPRE funciona
                    showStatus('üîÑ Storage falhou, usando m√©todo Base64...', 'warning');
                    
                    const base64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    console.log('üìù Base64 gerado, salvando no Firestore...');
                    
                    // Salvar arquivo como Base64 no Firestore
                    const fileDoc = await db.collection('uploadedFiles').add({
                        fileName: fileName,
                        base64Data: base64,
                        contentType: file.type,
                        size: file.size,
                        uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        uploadMethod: 'base64-fallback'
                    });
                    
                    console.log('‚úÖ Arquivo Base64 salvo no Firestore:', fileDoc.id);
                    showStatus('‚úÖ Upload Base64 realizado!', 'success');
                    
                    return base64; // Retorna base64 como URL
                }
                
            } catch (error) {
                console.error('‚ùå Erro cr√≠tico no upload:', error);
                showStatus('‚ùå Erro no upload: ' + error.message, 'error');
                throw error;
            }
        }

        // Salvar dados da imagem
        async function saveImageData(url, title, category, file) {
            try {
                const imageData = {
                    title: title,
                    section: category, // Usar 'section' que √© o padr√£o do seu banco
                    category: category, // Manter tamb√©m category para compatibilidade
                    url: url,
                    alt: title, // Adicionar alt text
                    description: `${title} - Adicionado via dashboard`, // Descri√ß√£o
                    active: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    size: file.size,
                    type: file.type,
                    filename: file.name,
                    migratedFrom: 'dashboard', // Identificar origem
                    originalId: `dashboard_${Date.now()}` // ID √∫nico
                };

                await db.collection('images').add(imageData);
                showStatus('‚úÖ Dados salvos no Firestore!', 'success');
                
                // Recarregar imagens
                setTimeout(loadImages, 1000);
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showStatus('‚ùå Erro ao salvar dados: ' + error.message, 'error');
            }
        }

        // Teste de conex√£o e diagn√≥stico
        async function testarConexao() {
            showStatus('üîß Testando conex√£o com Firebase...', 'info');
            console.log('üîß Iniciando testes de diagn√≥stico...');
            
            try {
                // Teste 1: Firebase inicializado
                if (!db || !storage) {
                    throw new Error('Firebase n√£o inicializado');
                }
                showStatus('‚úÖ Firebase inicializado', 'success');
                console.log('‚úÖ Firebase OK');
                
                // Teste 2: Conex√£o com Firestore
                await db.collection('images').limit(1).get();
                showStatus('‚úÖ Firestore conectado', 'success');
                console.log('‚úÖ Firestore OK');
                
                // Teste 3: Acesso ao Storage (tentativa de upload pequeno)
                try {
                    const testBlob = new Blob(['teste'], { type: 'text/plain' });
                    const testRef = storage.ref('test/conexao.txt');
                    await testRef.put(testBlob);
                    await testRef.delete(); // Limpar teste
                    showStatus('‚úÖ Storage funcionando', 'success');
                    console.log('‚úÖ Storage OK');
                } catch (storageError) {
                    console.warn('‚ö†Ô∏è Storage com problema:', storageError);
                    showStatus('‚ö†Ô∏è Storage com restri√ß√µes (usar√° m√©todo Base64)', 'warning');
                }
                
                // Teste 4: Verificar permiss√µes
                try {
                    await db.collection('images').add({
                        teste: true,
                        timestamp: new Date()
                    });
                    
                    // Remover teste
                    const testDocs = await db.collection('images').where('teste', '==', true).get();
                    testDocs.forEach(doc => doc.ref.delete());
                    
                    showStatus('‚úÖ Permiss√µes de escrita OK', 'success');
                    console.log('‚úÖ Permiss√µes OK');
                } catch (permError) {
                    showStatus('‚ùå Problema de permiss√µes no Firestore', 'error');
                    console.error('‚ùå Permiss√µes:', permError);
                }
                
                showStatus('üéâ Sistema funcionando! Pode fazer uploads.', 'success');
                console.log('üéâ Todos os testes passaram');
                
            } catch (error) {
                showStatus('‚ùå Problema na conex√£o: ' + error.message, 'error');
                console.error('‚ùå Erro nos testes:', error);
            }
        }

        // Deletar imagem
        async function deleteImage(id, category) {
            if (!confirm('Tem certeza que deseja deletar esta imagem?')) return;
            
            try {
                await db.collection('images').doc(id).delete();
                showStatus('‚úÖ Imagem deletada!', 'success');
                loadImages();
            } catch (error) {
                console.error('Erro ao deletar:', error);
                showStatus('‚ùå Erro ao deletar: ' + error.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('imageFile');
            const titleInput = document.getElementById('imageTitle');
            const categorySelect = document.getElementById('imageCategory');
            const uploadBtn = document.getElementById('uploadBtn');
            
            const file = fileInput.files[0];
            const title = titleInput.value.trim();
            const category = categorySelect.value;
            
            console.log('üîç Dados do formul√°rio:', { file: !!file, title, category });
            
            if (!file) {
                showStatus('‚ùå Selecione uma imagem!', 'error');
                return;
            }
            
            if (!title) {
                showStatus('‚ùå Digite um t√≠tulo!', 'error');
                return;
            }
            
            if (!category) {
                showStatus('‚ùå Selecione uma categoria!', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                showStatus('‚ùå Arquivo muito grande! M√°ximo 10MB.', 'error');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Enviando...';
            
            try {
                console.log('üöÄ Iniciando processo de upload...');
                showStatus(`üì§ Fazendo upload de "${title}"...`, 'info');
                
                const url = await uploadImage(file, title, category);
                console.log('‚úÖ URL obtida:', url);
                
                await saveImageData(url, title, category, file);
                console.log('‚úÖ Dados salvos no Firestore');
                
                // Limpar formul√°rio
                fileInput.value = '';
                titleInput.value = '';
                categorySelect.value = '';
                
                showStatus('üéâ Imagem adicionada com sucesso!', 'success');
                console.log('üéâ Upload completo!');
                
            } catch (error) {
                console.error('‚ùå Erro detalhado:', error);
                let errorMsg = 'Erro desconhecido';
                
                if (error.message.includes('permission')) {
                    errorMsg = 'Sem permiss√£o - verifique regras Firebase';
                } else if (error.message.includes('network')) {
                    errorMsg = 'Problema de conex√£o - tente novamente';
                } else if (error.message.includes('storage')) {
                    errorMsg = 'Erro no storage - usando m√©todo alternativo';
                } else {
                    errorMsg = error.message;
                }
                
                showStatus(`‚ùå Falha no upload: ${errorMsg}`, 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Adicionar Imagem';
            }
        });

        // Inicializar quando carregar
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('üîÑ Inicializando sistema...', 'info');
            initFirebase();
        });
    </script>
</body>
</html>