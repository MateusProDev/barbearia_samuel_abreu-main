// ========================================
// INICIALIZADOR DE DADOS FIREBASE
// Popula collections com dados padr√£o da Barbearia Samuel Abreu
// ========================================

class FirebaseDataInitializer {
    constructor() {
        this.defaultData = {
            // Conte√∫do Principal
            main: {
                title: "Barbearia Samuel Abreu",
                description: "11 anos renovando autoestimas com profissionais qualificados e produtos de qualidade. Venha viver essa experi√™ncia conosco.",
                mission: "Oferecer a nossos clientes atrav√©s de um ambiente agrad√°vel, um bom atendimento com um servi√ßo de qualidade, a fim de proporcionar o aumento da autoestima, em uma experi√™ncia √∫nica e pessoal.",
                keywords: "barbearia, cortes de cabelo, barba, Fortaleza, Samuel Abreu, fade, degrad√™, barbeiro profissional, pigmenta√ß√£o, sobrancelha",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: "system_initializer"
            },

            // Hor√°rios de Funcionamento
            schedule: {
                weekdayMorning: "08:00 √†s 12:00",
                weekdayAfternoon: "14:00 √†s 18:30",
                saturdayMorning: "08:00 √†s 12:00", 
                saturdayAfternoon: "14:00 √†s 18:30",
                sunday: "Fechado",
                specialNotes: "Hor√°rios podem variar em feriados",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: "system_initializer"
            },

            // Informa√ß√µes de Contato
            contact: {
                address: "R. Marieta Barreira, 810",
                neighborhood: "Centro",
                city: "Fortaleza",
                state: "CE",
                cep: "60000-000",
                phone: "(85) 98505-3792",
                whatsapp: "(85) 98505-3792",
                email: "contato@barbeariasamuelabreu.com",
                instagram: "https://www.instagram.com/barbearia_samuel_abreu/",
                facebook: "",
                website: "https://barbeariasamuelabreu.com",
                googleMaps: "https://maps.google.com/?q=R.+Marieta+Barreira,+810,+Fortaleza,+CE",
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: "system_initializer"
            }
        };

        this.adminUsers = [
            {
                email: "admin@barbeariasamuelabreu.com",
                name: "Administrador",
                role: "admin",
                isAdmin: true,
                permissions: ["read", "write", "delete", "manage_users"],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: "system_initializer"
            },
            {
                email: "samuel@barbeariasamuelabreu.com", 
                name: "Samuel Abreu",
                role: "owner",
                isAdmin: true,
                permissions: ["read", "write", "delete", "manage_users", "owner"],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: "system_initializer"
            }
        ];

        this.servicesData = [
            {
                name: "CABELO E BARBA",
                description: "Corte completo com acabamento perfeito da barba, deixando voc√™ com visual impec√°vel",
                price: "R$ 35,00",
                duration: "45 min",
                category: "combo",
                isActive: true
            },
            {
                name: "CORTE INFANTIL", 
                description: "Atendimento especializado para crian√ßas com ambiente acolhedor e profissionais experientes",
                price: "R$ 20,00",
                duration: "30 min", 
                category: "infantil",
                isActive: true
            },
            {
                name: "PIGMENTA√á√ÉO",
                description: "T√©cnica avan√ßada para cobertura de fios brancos e realce da cor natural",
                price: "R$ 40,00",
                duration: "60 min",
                category: "coloracao",
                isActive: true
            },
            {
                name: "SOBRANCELHA",
                description: "Design e modelagem de sobrancelhas para valorizar o olhar masculino", 
                price: "R$ 15,00",
                duration: "20 min",
                category: "design",
                isActive: true
            },
            {
                name: "CORTE NA TESOURA",
                description: "T√©cnica cl√°ssica com acabamento refinado para um visual sofisticado",
                price: "R$ 25,00", 
                duration: "40 min",
                category: "corte",
                isActive: true
            },
            {
                name: "LUZES",
                description: "Mechas e luzes para criar um visual moderno e diferenciado",
                price: "R$ 60,00",
                duration: "90 min",
                category: "coloracao", 
                isActive: true
            },
            {
                name: "PLATINADO",
                description: "Colora√ß√£o platinada para um visual arrojado e contempor√¢neo",
                price: "R$ 80,00",
                duration: "120 min",
                category: "coloracao",
                isActive: true
            }
        ];
    }

    // Inicializar todos os dados
    async initializeAllData() {
        if (!window.db) {
            throw new Error('Firebase n√£o inicializado');
        }

        console.log('üöÄ Iniciando inicializa√ß√£o dos dados...');

        const results = {
            content: { created: 0, skipped: 0, errors: 0 },
            users: { created: 0, skipped: 0, errors: 0 },
            services: { created: 0, skipped: 0, errors: 0 }
        };

        try {
            // Inicializar conte√∫do do site
            await this.initializeSiteContent(results.content);
            
            // Inicializar usu√°rios admin
            await this.initializeAdminUsers(results.users);
            
            // Inicializar servi√ßos
            await this.initializeServices(results.services);

            console.log('‚úÖ Inicializa√ß√£o completa:', results);
            return results;

        } catch (error) {
            console.error('‚ùå Erro na inicializa√ß√£o:', error);
            throw error;
        }
    }

    // Inicializar conte√∫do do site
    async initializeSiteContent(results) {
        console.log('üìù Inicializando conte√∫do do site...');

        for (const [docId, data] of Object.entries(this.defaultData)) {
            try {
                // Verificar se j√° existe
                const doc = await db.collection('siteContent').doc(docId).get();
                
                if (doc.exists) {
                    console.log(`‚è≠Ô∏è Conte√∫do j√° existe: ${docId}`);
                    results.skipped++;
                    continue;
                }

                // Criar documento
                await db.collection('siteContent').doc(docId).set(data);
                console.log(`‚úÖ Criado: ${docId}`);
                results.created++;

            } catch (error) {
                console.error(`‚ùå Erro ao criar ${docId}:`, error);
                results.errors++;
            }
        }
    }

    // Inicializar usu√°rios admin
    async initializeAdminUsers(results) {
        console.log('üë§ Inicializando usu√°rios admin...');

        for (const userData of this.adminUsers) {
            try {
                // Verificar se usu√°rio j√° existe
                const existingUser = await db.collection('users')
                    .where('email', '==', userData.email)
                    .get();

                if (!existingUser.empty) {
                    console.log(`‚è≠Ô∏è Usu√°rio j√° existe: ${userData.email}`);
                    results.skipped++;
                    continue;
                }

                // Criar usu√°rio
                await db.collection('users').add(userData);
                console.log(`‚úÖ Usu√°rio criado: ${userData.email}`);
                results.created++;

            } catch (error) {
                console.error(`‚ùå Erro ao criar usu√°rio ${userData.email}:`, error);
                results.errors++;
            }
        }
    }

    // Inicializar servi√ßos
    async initializeServices(results) {
        console.log('‚úÇÔ∏è Inicializando servi√ßos...');

        for (const serviceData of this.servicesData) {
            try {
                // Verificar se servi√ßo j√° existe
                const existingService = await db.collection('services')
                    .where('name', '==', serviceData.name)
                    .get();

                if (!existingService.empty) {
                    console.log(`‚è≠Ô∏è Servi√ßo j√° existe: ${serviceData.name}`);
                    results.skipped++;
                    continue;
                }

                // Adicionar timestamps
                const serviceWithTimestamp = {
                    ...serviceData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: "system_initializer"
                };

                // Criar servi√ßo
                await db.collection('services').add(serviceWithTimestamp);
                console.log(`‚úÖ Servi√ßo criado: ${serviceData.name}`);
                results.created++;

            } catch (error) {
                console.error(`‚ùå Erro ao criar servi√ßo ${serviceData.name}:`, error);
                results.errors++;
            }
        }
    }

    // Verificar se inicializa√ß√£o √© necess√°ria
    async checkIfInitializationNeeded() {
        try {
            // Verificar se existe conte√∫do principal
            const mainDoc = await db.collection('siteContent').doc('main').get();
            
            if (mainDoc.exists) {
                console.log('‚úÖ Dados j√° inicializados');
                return false;
            }

            console.log('‚ö†Ô∏è Inicializa√ß√£o necess√°ria');
            return true;

        } catch (error) {
            console.error('Erro ao verificar inicializa√ß√£o:', error);
            return true;
        }
    }

    // Executar inicializa√ß√£o completa
    async runFullInitialization() {
        try {
            const needsInit = await this.checkIfInitializationNeeded();
            
            if (!needsInit) {
                return { 
                    status: 'skipped', 
                    message: 'Dados j√° inicializados' 
                };
            }

            const results = await this.initializeAllData();
            
            return {
                status: 'success',
                message: 'Inicializa√ß√£o completa',
                details: results
            };

        } catch (error) {
            return {
                status: 'error',
                message: error.message,
                error: error
            };
        }
    }

    // Resetar dados (cuidado - apaga tudo!)
    async resetAllData() {
        if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODOS os dados!\n\nTem certeza?')) {
            return;
        }

        try {
            // Apagar conte√∫do do site
            const contentDocs = await db.collection('siteContent').get();
            const contentBatch = db.batch();
            contentDocs.forEach(doc => contentBatch.delete(doc.ref));
            await contentBatch.commit();

            // Apagar usu√°rios
            const userDocs = await db.collection('users').get();
            const userBatch = db.batch();
            userDocs.forEach(doc => userBatch.delete(doc.ref));
            await userBatch.commit();

            // Apagar servi√ßos
            const serviceDocs = await db.collection('services').get();
            const serviceBatch = db.batch();
            serviceDocs.forEach(doc => serviceBatch.delete(doc.ref));
            await serviceBatch.commit();

            console.log('üóëÔ∏è Todos os dados foram removidos');
            
            // Reinicializar
            return await this.runFullInitialization();

        } catch (error) {
            console.error('Erro ao resetar dados:', error);
            throw error;
        }
    }
}

// Fun√ß√£o global para inicializar dados
window.initializeFirebaseData = async function() {
    if (!window.db) {
        alert('‚ùå Firebase n√£o inicializado. Aguarde ou recarregue a p√°gina.');
        return;
    }

    try {
        const initializer = new FirebaseDataInitializer();
        const result = await initializer.runFullInitialization();
        
        if (result.status === 'success') {
            const details = result.details;
            let message = '‚úÖ Dados inicializados com sucesso!\n\n';
            message += `üìù Conte√∫do: ${details.content.created} criados, ${details.content.skipped} j√° existiam\n`;
            message += `üë§ Usu√°rios: ${details.users.created} criados, ${details.users.skipped} j√° existiam\n`;
            message += `‚úÇÔ∏è Servi√ßos: ${details.services.created} criados, ${details.services.skipped} j√° existiam`;
            
            alert(message);
            
            // Recarregar dashboard se dispon√≠vel
            if (window.dashboard) {
                window.location.reload();
            }
        } else if (result.status === 'skipped') {
            alert('‚ÑπÔ∏è ' + result.message);
        } else {
            alert('‚ùå Erro: ' + result.message);
        }

    } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        alert(`‚ùå Erro na inicializa√ß√£o: ${error.message}`);
    }
};

// Fun√ß√£o para resetar dados
window.resetFirebaseData = async function() {
    if (!window.db) {
        alert('‚ùå Firebase n√£o inicializado.');
        return;
    }

    try {
        const initializer = new FirebaseDataInitializer();
        const result = await initializer.resetAllData();
        
        alert('‚úÖ Dados resetados e reinicializados!');
        window.location.reload();
        
    } catch (error) {
        console.error('Erro no reset:', error);
        alert(`‚ùå Erro no reset: ${error.message}`);
    }
};

// Auto-inicializa√ß√£o na primeira carga
document.addEventListener('DOMContentLoaded', () => {
    // Aguardar Firebase carregar
    const autoInit = async () => {
        if (typeof firebase !== 'undefined' && firebase.firestore && window.db) {
            try {
                const initializer = new FirebaseDataInitializer();
                const needsInit = await initializer.checkIfInitializationNeeded();
                
                if (needsInit && window.location.pathname.includes('admin-dashboard')) {
                    console.log('üîÑ Auto-inicializa√ß√£o detectada');
                    
                    // Mostrar bot√£o de inicializa√ß√£o
                    setTimeout(() => {
                        const initBtn = document.createElement('button');
                        initBtn.textContent = 'üöÄ Inicializar Dados Firebase';
                        initBtn.className = 'action-btn';
                        initBtn.style.cssText = 'position: fixed; bottom: 80px; right: 20px; z-index: 1000; background: linear-gradient(45deg, #4CAF50, #45a049);';
                        initBtn.onclick = window.initializeFirebaseData;
                        
                        document.body.appendChild(initBtn);
                    }, 2000);
                }
            } catch (error) {
                console.error('Erro na verifica√ß√£o de inicializa√ß√£o:', error);
            }
        } else {
            setTimeout(autoInit, 1000);
        }
    };
    
    autoInit();
});

// Exportar para uso global
if (typeof window !== 'undefined') {
    window.FirebaseDataInitializer = FirebaseDataInitializer;
}
